## コールバックの実装方法

### 今回のテーマ
コールバックとは何かを理解し、実際にコールバックを実装する。


### コールバックとは
オブジェクトの登録（create）・削除（destroy）など、あるイベントの前後に、指定した処理が実行されるよう設定しておくメソッドのこと。

（例）データを保存する前に、ある項目が空白であれば、その項目に特定の値を代入するメソッドbr
     この`データを保存する前`、という`タイミングを指定したメソッド`を、`コールバックメソッド`という。


### コールバックの実装


#### アプリの用意
・`callback_app`という名前で新しくアプリを作成してください。

・アプリを作成したら、`name`カラムを持ったUserモデルを作成してください。

#### コールバックの定義の方法

（１）プライベートメソッドでの呼び出し

まずはプライベートメソッドを定義して、呼び出す方法です。

nameの値が空白の場合、自動的に「Taro」を代入するメソッドを作成して、データの登録の直前に呼び出すように設定します。

設定の方法は、次のとおりです。

・nameの値が空白の場合、「Taro」を代入するプライベートメソッドを生成

・データの登録の直前に、プライベートメソッドを呼び出すコールバックメソッドを指定

`app/models/user.rb`

```rb
class User < ActiveRecord::Base
  before_create :ensure_has_name       #コールバックメソッドの指定

  private
  def ensure_has_name                  #プライベートメソッドの生成
    self.name = 'Taro' if name.blank?
  end
end
```

実際に検証してみましょう。

```
$ rails c
> User.create
   (0.1ms)  begin transaction
  SQL (0.5ms)  INSERT INTO "users" ("created_at", "updated_at", "name") VALUES (?, ?, ?)  [["created_at", "2017-08-20 09:31:27.891895"], ["updated_at", "2017-08-20 09:31:27.891895"], ["name", "Taro"]]
   (10.0ms)  commit transaction
 => #<User id: 1, name: "Taro", created_at: "2017-08-20 09:31:27", updated_at: "2017-08-20 09:31:27">
```

ここでは、`User.create`と記述し、`name`には何も値を代入していません。

しかし、実行結果を見ると、`name`に`Taro`という値が保存されているのがわかります。

以上が、プライベートメソッドで呼び出す場合の方法です。

プライベートメソッドでの呼び出しは、複雑な処理を実行したい場合に向いているメリットがあります。


（２）ブロック形式での呼び出し

コールバックメソッドはブロック形式で呼び出すこともできます。

ブロック形式の場合、引数として関連する値を受け取ることができます。

受け取る値は、コールバックの種類によって変わってきます。

今回はafter_initializeメソッドを使用してみましょう。

after_initializeメソッドは、Active Recordオブジェクトがインスタンス化されるたびに呼び出されます。

`app/models/user.rb`

```
class User < ActiveRecord::Base

  after_initialize do |user|         #ブロック形式でのコールバック指定
    puts "オブジェクトを生成しました！"
  end
// 省略
```

実際にUserモデルのインスタンスを生成してみましょう。

```
$ rails c
> User.new
オブジェクトを生成しました！
 => #<User id: nil, name: nil, created_at: nil, updated_at: nil>
```

Userモデルがインスタンス化されたことで、`after_initializeメソッド`が呼び出され、`オブジェクトを生成しました！`というメッセージが表示されていることを確認できます。

以上が、ブロック形式で呼び出す場合の方法です。

ブロック形式での呼び出しは、簡単な処理を実行したい場合にシンプルに書けるというメリットがあります。

お疲れ様でした。
テキストは以上となります。


ここからは、小課題に取り組んでいただきます。

小課題は課題として提出する必要はありませんが、必ず一度手を動かして取り組んでみてください！

（プログラミングは手を動かす経験がとても大切です。課題に対する質問や解答の確認がしたい場合は、ぜひ質問投稿にご投稿ください）

小課題の解答例は、このテキストの一番最後に記載しています。


小課題

※テキストで使用したUserモデルを使用してください。br
Userデータを登録し、検索メソッド（find）でデータが見つかった時に`データが見つかりました!`というメッセージが表示されるロールバックメソッドを作成してください。


質問はこちらのURLにお願いいたします。br
https://diveintocode.jp/diver/questions/new


テキストフィードバックについてbr
今後のDIVE INTO CODEの発展のために、お時間があれば フィードバックのご協力をお願い致します。br
 以下を参考に、DIVERのコメント欄にご投稿して頂けると有難いです。br
・テキストの難易度は適切であったかbr
・テキストの分量は適切であったかbr
・説明していない用語はなかったかbr
・テキストに間違いはなかったかbr
・テキストのゴールに対して適切な内容であったかbr
・他に説明を加えてほしいことは無かったかbr
・やってて楽しいテキストであったかbr
・有益なテキストであったかbr
その他なんでもご意見をご投稿くださいbr
DIVER質問機能のコメント欄に記述をお願い致します。

小課題解答例

`app/models/user.rb`
```
class User < ApplicationRecord
  before_create :ensure_has_name

  after_find do |user|
    puts "データが見つかりました！！"
  end

  private
  def ensure_has_name
   self.name = "Taro" if name.blank?
  end

end
```

```
$ rails c
> User.create
 => #<User id: 1, name: Taro, ・・・>
>User.find(1)
データが見つかりました！！
=> #<User id: 1, name: Taro, ・・・>
```
